name: Deploy to Vultr

on:
  workflow_dispatch:
    inputs:
      vultr_host:
        description: 'Vultr server IP address'
        required: false
      vultr_user:
        description: 'SSH username'
        required: false
        default: 'root'
  push:
    branches: [main]
    paths:
      - 'nginx/**'
      - 'playwright/**'
      - 'puppeteer/**'
      - 'selenium/**'
      - 'universal/**'
      - 'scripts/**'
      - 'docker-compose.yml'
      - 'openmemory-src/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare OpenMemory Source
        run: |
          # Clone OpenMemory if not in repo
          if [ ! -d "openmemory-src" ]; then
            echo "ðŸ“¦ Cloning OpenMemory source..."
            git clone https://github.com/CaviraOSS/OpenMemory.git openmemory-src
            echo "âœ… OpenMemory source ready"
          else
            echo "âœ… OpenMemory source already in repository"
          fi

      - name: Deploy to Vultr
        env:
          VULTR_HOST: ${{ github.event.inputs.vultr_host || secrets.VULTR_HOST }}
          VULTR_USER: ${{ github.event.inputs.vultr_user || secrets.VULTR_USER || 'root' }}
          SSH_PRIVATE_KEY: ${{ secrets.VULTR_SSH_KEY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/vultr_key
          chmod 600 ~/.ssh/vultr_key
          ssh-keyscan -H $VULTR_HOST >> ~/.ssh/known_hosts

          # Deploy files
          echo "ðŸ“¦ Deploying to $VULTR_HOST..."
          
          # Create deployment directory
          ssh -i ~/.ssh/vultr_key $VULTR_USER@$VULTR_HOST "mkdir -p /opt/docker-scrapers"

          # Copy all files including openmemory-src
          scp -i ~/.ssh/vultr_key -r \
            nginx playwright puppeteer selenium universal scripts openmemory-src \
            docker-compose.yml install-docker-vultr.sh \
            DEPLOYMENT.md README.md \
            $VULTR_USER@$VULTR_HOST:/opt/docker-scrapers/

          # Run remote commands on the server
          ssh -i ~/.ssh/vultr_key $VULTR_USER@$VULTR_HOST << 'ENDSSH'
            cd /opt/docker-scrapers

            # Verify OpenMemory source exists
            if [ ! -d "openmemory-src" ]; then
              echo "âŒ OpenMemory source missing, cloning..."
              git clone https://github.com/CaviraOSS/OpenMemory.git openmemory-src
            fi
            
            # Generate API keys if .env doesn't exist
            if [ ! -f .env ]; then
              echo "ðŸ”‘ Generating API keys..."
              bash scripts/generate-keys.sh
            else
              # Ensure OPENMEMORY_API_KEY exists in existing .env
              if ! grep -q "OPENMEMORY_API_KEY" .env; then
                echo "ðŸ”‘ Adding OPENMEMORY_API_KEY to existing .env..."
                echo "" >> .env
                echo "# OpenMemory API Key" >> .env
                echo "OPENMEMORY_API_KEY=$(openssl rand -base64 32)" >> .env
              fi
            fi

            # Start services
            echo "ðŸš€ Starting services..."
            docker-compose down
            docker-compose up -d --build
            
            echo "âœ… Deployment complete!"
            docker-compose ps
ENDSSH

      - name: Verify deployment
        env:
          VULTR_HOST: ${{ github.event.inputs.vultr_host || secrets.VULTR_HOST }}
          VULTR_USER: ${{ github.event.inputs.vultr_user || secrets.VULTR_USER || 'root' }}
          SSH_PRIVATE_KEY: ${{ secrets.VULTR_SSH_KEY }}
        run: |
          # Setup SSH again (each step runs in a clean shell)
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/vultr_key
          chmod 600 ~/.ssh/vultr_key
          ssh-keyscan -H $VULTR_HOST >> ~/.ssh/known_hosts

          # Verify running containers
          ssh -i ~/.ssh/vultr_key $VULTR_USER@$VULTR_HOST "cd /opt/docker-scrapers && docker-compose ps"
          echo "âœ… Services running at http://$VULTR_HOST"
